---
title: "Storyboard"
output: 
  flexdashboard::flex_dashboard:
    storyboard: true
---

### Classification & Clustering

``` {r}
library(spotifyr)
library(tidyverse)
library(tidymodels)
library(ggplot2)
library(gganimate)
library(compmus)
library(ggdendro)
library(heatmaply)

tidal <-
  get_playlist_audio_features("tidal", "6AWmwswoM3JHtgSFC6FNfU") |>
  add_audio_analysis() |>
  mutate(
    segments = map2(segments, key, compmus_c_transpose),
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      ),
    timbre =
      map(
        segments,
        compmus_summarise, timbre,
        method = "mean"
      )
  ) |>
  mutate(pitches = map(pitches, compmus_normalise, "clr")) |>
  mutate_at(vars(pitches, timbre), map, bind_rows) |>
  unnest(cols = c(pitches, timbre))

tidal_juice <-
  recipe(
    track.name ~
      danceability +
      energy +
      loudness +
      speechiness +
      acousticness +
      instrumentalness +
      liveness +
      valence +
      tempo,
    data = tidal
  ) |>
  step_center(all_predictors()) |>
  step_scale(all_predictors()) |> 
  # step_range(all_predictors()) |> 
  prep(tidal |> mutate(track.name = str_trunc(track.name, 20))) |>
  juice() |>
  column_to_rownames("track.name")

tidal_dist <- dist(tidal_juice, method = "euclidean")

heatmaply(
  tidal_juice,
  hclustfun = hclust,
  hclust_method = "single",  # Change for single, average, or complete linkage.
  dist_method = "euclidean"
)

```
```
-------------------------------------------------------------------------------

I think it's interesting to see which track features are strongly correlated with eachother in Fiona Apple's debut.


### Chordogram

```{r}
library(tidyverse)
library(compmus)

circshift <- function(v, n) {
  if (n == 0) v else c(tail(v, n), head(v, -n))
}

#      C     C#    D     Eb    E     F     F#    G     Ab    A     Bb    B
major_chord <-
  c(   1,    0,    0,    0,    1,    0,    0,    1,    0,    0,    0,    0)
minor_chord <-
  c(   1,    0,    0,    1,    0,    0,    0,    1,    0,    0,    0,    0)
seventh_chord <-
  c(   1,    0,    0,    0,    1,    0,    0,    1,    0,    0,    1,    0)

major_key <-
  c(6.35, 2.23, 3.48, 2.33, 4.38, 4.09, 2.52, 5.19, 2.39, 3.66, 2.29, 2.88)
minor_key <-
  c(6.33, 2.68, 3.52, 5.38, 2.60, 3.53, 2.54, 4.75, 3.98, 2.69, 3.34, 3.17)

chord_templates <-
  tribble(
    ~name, ~template,
    "Gb:7", circshift(seventh_chord, 6),
    "Gb:maj", circshift(major_chord, 6),
    "Bb:min", circshift(minor_chord, 10),
    "Db:maj", circshift(major_chord, 1),
    "F:min", circshift(minor_chord, 5),
    "Ab:7", circshift(seventh_chord, 8),
    "Ab:maj", circshift(major_chord, 8),
    "C:min", circshift(minor_chord, 0),
    "Eb:7", circshift(seventh_chord, 3),
    "Eb:maj", circshift(major_chord, 3),
    "G:min", circshift(minor_chord, 7),
    "Bb:7", circshift(seventh_chord, 10),
    "Bb:maj", circshift(major_chord, 10),
    "D:min", circshift(minor_chord, 2),
    "F:7", circshift(seventh_chord, 5),
    "F:maj", circshift(major_chord, 5),
    "A:min", circshift(minor_chord, 9),
    "C:7", circshift(seventh_chord, 0),
    "C:maj", circshift(major_chord, 0),
    "E:min", circshift(minor_chord, 4),
    "G:7", circshift(seventh_chord, 7),
    "G:maj", circshift(major_chord, 7),
    "B:min", circshift(minor_chord, 11),
    "D:7", circshift(seventh_chord, 2),
    "D:maj", circshift(major_chord, 2),
    "F#:min", circshift(minor_chord, 6),
    "A:7", circshift(seventh_chord, 9),
    "A:maj", circshift(major_chord, 9),
    "C#:min", circshift(minor_chord, 1),
    "E:7", circshift(seventh_chord, 4),
    "E:maj", circshift(major_chord, 4),
    "G#:min", circshift(minor_chord, 8),
    "B:7", circshift(seventh_chord, 11),
    "B:maj", circshift(major_chord, 11),
    "D#:min", circshift(minor_chord, 3)
  )

key_templates <-
  tribble(
    ~name, ~template,
    "Gb:maj", circshift(major_key, 6),
    "Bb:min", circshift(minor_key, 10),
    "Db:maj", circshift(major_key, 1),
    "F:min", circshift(minor_key, 5),
    "Ab:maj", circshift(major_key, 8),
    "C:min", circshift(minor_key, 0),
    "Eb:maj", circshift(major_key, 3),
    "G:min", circshift(minor_key, 7),
    "Bb:maj", circshift(major_key, 10),
    "D:min", circshift(minor_key, 2),
    "F:maj", circshift(major_key, 5),
    "A:min", circshift(minor_key, 9),
    "C:maj", circshift(major_key, 0),
    "E:min", circshift(minor_key, 4),
    "G:maj", circshift(major_key, 7),
    "B:min", circshift(minor_key, 11),
    "D:maj", circshift(major_key, 2),
    "F#:min", circshift(minor_key, 6),
    "A:maj", circshift(major_key, 9),
    "C#:min", circshift(minor_key, 1),
    "E:maj", circshift(major_key, 4),
    "G#:min", circshift(minor_key, 8),
    "B:maj", circshift(major_key, 11),
    "D#:min", circshift(minor_key, 3)
  )

carrion <-
  get_tidy_audio_analysis("3pOxPpj3JhsmRAlaMrrxSy") |>
  compmus_align(bars, segments) |>
  select(bars) |>
  unnest(bars) |>
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "euclidean"
      )
  )

carrion |> 
  compmus_match_pitch_template(
    key_templates,         # Change to chord_templates if descired
    method = "euclidean",  # Try different distance metrics
    norm = "euclidean"     # Try different norms
  ) |>
ggplot(
  aes(x = start + duration / 2, width = duration, y = name, fill = d)
) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  theme_minimal() +
  labs(x = "Time (s)", y = "") +
  geom_vline(xintercept = c(82, 114, 165), linetype = "dotted", color = "white", linewidth = 1.5)  
```

-------------------------------------------------------------------------------

For the visualisation of different chords I picked the final track of Fiona Apple’s debut album Tidal: Carrion. In this track Fiona alternates between a C minor and C major section. Indicated by the dotted lines you can see a clear switch on the chordogram.

### Self Similarity and Spectogram

```{r}
library(tidyverse)
library(spotifyr)
library(compmus)

fast_as_you_can <-
  get_tidy_audio_analysis("1UmmSKPdCtBuJsmbZG9G3u") |> # Change URI.
  compmus_align(bars, segments) |>                     # Change `bars`
  select(bars) |>                                      #   in all three
  unnest(bars) |>                                      #   of these lines.
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "rms", norm = "euclidean"              # Change summary & norm.
      )
  ) |>
  mutate(
    timbre =
      map(segments,
        compmus_summarise, timbre,
        method = "rms", norm = "euclidean"              # Change summary & norm.
      )
  )

fast_as_you_can |>
  compmus_gather_timbre() |>
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = basis,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  scale_fill_viridis_c() +                              
  theme_classic()

fast_as_you_can |>
  compmus_self_similarity(timbre, "cosine") |> 
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_fixed() +
  scale_fill_viridis_c(guide = "none") +
  theme_classic() +
  labs(x = "", y = "")

fast_as_you_can |>
  compmus_self_similarity(pitches, "cosine") |> 
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_fixed() +
  scale_fill_viridis_c(guide = "none") +
  theme_classic() +
  labs(x = "", y = "")
```

------------------------------------------------------------------------

I have chosen my favorite track of Fiona Apple: Fast as you can for these visualizations. The reason why is because the structure of the track is very interesting. And while you may not see that very clearly in Plot 1: Spectrogram of Pitches and Plot 2: Self Similarity Matrix of Timbre. It is very evident in the third visualization. The song can be divided into 6 sections. The song goes from a verse to a chorus, to a breakdown (visible in yellow) to another verse and chorus which eventually concludes in a long outro.

### An Introduction to Fiona Apple

```{r}
```

------------------------------------------------------------------------

As for my corpus that I will use to build my portfolio, I will be using the discography of Fiona Apple (1977) as my database. Fiona, still a teenager, came onto the alternative jazz and pop scene in the late 90s with aggressive piano ballads, emotional vocal deliveries and amazing songwriting skills. Even though I will not be analyzing the latter as much, it is still nice to mention.

I will be analyzing her sound as it progresses over the years. Fiona Apple has released 5 full studio albums between the years of 1996 and 2020: Tidal (1996), When The Pawn.. (1999), Extraordinary Machine (2005), The Idler Wheel.. (2012) and Fetch The Bolt Cutters (2020). A ton has changed in the musical landscape in these 24 years, but Fiona has managed to find her place in it. She has adapted her sound in a lot of ways, never losing what makes a Fiona Apple song a Fiona Apple song.

I will only be using the songs of the albums and not any of the singles. This is quite representative of her full discography as she doesn’t have many singles that aren’t a part of the full album discography. It is the progression of every single full project that i want to measure.

Some tracks, typical & atypical I would like to analyze:

Heavy Balloon - Fetch The Bolt Cutters - This is very different from the regular Fiona Apple formula and sounds more like something Lorde would’ve made in 2016.

Fast As You Can - When The Pawn… - To me personally, the quintessential Fiona Apple song. It is what I would constitute the formula.

------------------------------------------------------------------------

### Radical Sensitivity: Visualized

```{r}
knitr::opts_chunk$set(echo = TRUE)
library(shiny)
library(shinyjs)
library(spotifyr)
library(tidyverse)
library(ggplot2)
library(gganimate)
corpus <- get_playlist_audio_features("", "7LDyKnV7gitLREBYl6kVLz")

corpus <- corpus %>% 
  mutate(track.album.name = ifelse(track.album.name == "The Idler Wheel Is Wiser Than the Driver of the Screw and Whipping Cords Will Serve You More Than Ropes Will Ever Do (Expanded Edition)",
                                   "The Idler Wheel...", track.album.name))

# Specify the order of albums
album_order <- c("Tidal", "When The Pawn...", "Extraordinary Machine", "The Idler Wheel...", "Fetch The Bolt Cutters")

# Create a new factor column with the desired order
corpus$track.album.name <- factor(corpus$track.album.name, levels = album_order)

# Create a ggplot with the desired order and text under each plot
p <- ggplot(corpus, aes(x = acousticness, y = valence, size = energy, color = factor(track.album.name))) + 
  geom_point() +
  facet_wrap(~track.album.name, ncol = 2, drop = TRUE) +
  coord_fixed() +
  theme(strip.text = element_text(size = 8) + 
  guides(color = FALSE))
# Print the plot
print(p)

view(corpus)
```

### 

```{r}
```

### Conclusions

```{r}
```

------------------------------------------------------------------------

I have to analyze the corpus further to make any conclusions. My idea for the structure of the portfolio is going to be inspired by an profile by the New Yorker on Fiona Apple called: Fiona Apple’s Art of Radical Sensitivity. I will also be expanding the corpus further by including music of her peers at the time.
